<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard | Tudduke Okufa Ministry</title>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="/socket.io/socket.io.js"></script>

    <style>
        :root {
            --brand: #b30000;
            --bg: #f4f4f4;
            --card: #fff;
            --radius: 16px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        body {
            font-family: Arial, sans-serif;
            background: var(--bg);
            color: #333;
        }

        /* HEADER */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: var(--brand);
            color: #fff;
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 1002;
        }

        .menu-toggle {
            font-size: 1.8rem;
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            margin-right: 16px;
        }

        .header-text h1 {
            font-size: 1.6rem
        }

        .header-text p {
            font-size: .85rem;
            opacity: .9
        }

        /* SIDEBAR */
        aside {
            position: fixed;
            top: 0;
            left: -260px;
            width: 260px;
            height: 100vh;
            background: #fff;
            padding: 90px 20px;
            transition: .3s;
            z-index: 1001;
        }

        aside.active {
            left: 0
        }

        aside a {
            display: block;
            padding: 14px 16px;
            margin-bottom: 12px;
            border-radius: 14px;
            text-decoration: none;
            color: var(--brand);
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, .08);
        }

        /* OVERLAY */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .35);
            opacity: 0;
            pointer-events: none;
            transition: .2s;
        }

        .overlay.active {
            opacity: 1;
            pointer-events: auto
        }

        /* DASHBOARD CONTENT */
        .dashboard-section {
            margin-top: 80px;
            padding: 40px 20px;
            min-height: calc(100vh - 80px - 200px);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .dash-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .dash-header h2 {
            color: var(--brand);
            font-size: 1.8rem;
        }

        .btn {
            padding: 10px 20px;
            background: var(--brand);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn:hover {
            background: #900000;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #333;
        }

        .btn-secondary:hover {
            background: #000;
        }

        .card {
            background: #fff;
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: 0 6px 16px rgba(0, 0, 0, .1);
            margin-bottom: 30px;
        }

        .card h3 {
            color: var(--brand);
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        /* FORMS */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .full-width {
            grid-column: span 2;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        input,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
        }

        /* LIST */
        .sermon-list {
            display: grid;
            gap: 15px;
        }

        .sermon-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--brand);
        }

        .sermon-info h4 {
            margin: 0 0 5px 0;
            font-size: 1.1rem;
        }

        .sermon-info p {
            margin: 0;
            font-size: 0.9rem;
            color: #666;
        }

        .actions button {
            background: none;
            border: none;
            cursor: pointer;
            color: #888;
            transition: 0.2s;
        }

        .actions button:hover {
            color: var(--brand);
        }

        /* DESKTOP SIDEBAR */
        @media (min-width: 1024px) {
            aside#sidebar {
                left: 0;
                box-shadow: none;
                border-right: 1px solid #ddd;
            }

            .menu-toggle {
                display: none;
            }

            header {
                padding-left: 280px;
            }

            .dashboard-section,
            footer {
                margin-left: 260px;
                width: auto;
            }

            .overlay {
                display: none !important;
            }
        }

        @media (max-width: 600px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .full-width {
                grid-column: span 1;
            }
        }

        /* FOOTER */
        .site-footer {
            background: linear-gradient(to bottom, #1a1a1a, #000);
            color: #ccc;
            padding: 40px 20px;
            text-align: center;
            border-top: 4px solid var(--brand);
        }

        .footer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .footer-brand h3 {
            color: white;
            font-size: 1.5rem;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .leader-text {
            color: var(--brand);
            font-weight: bold;
            font-style: italic;
        }

        .footer-dev p {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .dev-link {
            display: inline-block;
            color: #fff;
            text-decoration: none;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            transition: 0.3s;
        }

        .dev-link:hover {
            background: var(--brand);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(179, 0, 0, 0.3);
        }

        .footer-bottom {
            font-size: 0.85rem;
            opacity: 0.7;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 20px;
        }

        @media (min-width: 768px) {
            .footer-content {
                flex-direction: row;
                justify-content: space-around;
                text-align: left;
            }

            .footer-brand {
                align-items: flex-start;
            }
        }

        /* Mobile Dashboard Fixes */
        @media (max-width: 600px) {
            .dash-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .dash-header button {
                width: 100%;
            }

            .sermon-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .actions {
                width: 100%;
                display: flex;
                justify-content: flex-end;
                border-top: 1px solid #eee;
                padding-top: 10px;
                margin-top: 5px;
            }
        }
    </style>
</head>

<body>

    <header>
        <button class="menu-toggle" id="menu">‚ò∞</button>
        <div class="header-text">
            <h1>TUDDUKE OKUFA</h1>
            <p>Preparing People for the Second Coming of Jesus Christ</p>
        </div>
    </header>

    <aside id="sidebar">
        <a href="index.html">Kids Home</a>
        <a href="videos.html">Kids Videos</a>
        <a href="quiz.html">Bible Quiz</a>
        <a href="memory-verses.html">Memory Verses</a>
        <a href="children-sermon.html">Children Sermons</a>
        <a href="weekly-lesson.html">Weekly Lessons</a>
        <a href="parents.html">Parents & Teachers</a>
        <a href="auth.html" style="color: var(--brand); border: 2px solid var(--brand);">üîê Login / Join</a>
        <a href="../index.html">‚¨ÖÔ∏èüè† Home Page</a>
    </aside>

    <div class="overlay" id="overlay"></div>

    <section class="dashboard-section">
        <div class="container">

            <div class="dash-header">
                <h2>Teacher Dashboard: <span id="teacherDisplay"></span></h2>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>

            <!-- ADD SERMON FORM -->
            <div class="card">
                <h3 id="formTitle">Add New Sermon</h3>
                <form id="addSermonForm">
                    <input type="hidden" id="editId">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Title</label>
                            <input type="text" id="title" required placeholder="e.g. Noah's Ark">
                        </div>
                        <div class="form-group">
                            <label>Video URL (YouTube ID or Link)</label>
                            <input type="text" id="videoUrl" required placeholder="e.g. dQw4w9WgXcQ">
                        </div>
                        <div class="form-group">
                            <label>Teacher Name</label>
                            <input type="text" id="teacherName" required placeholder="e.g. Tr. Sarah">
                        </div>
                        <div class="form-group full-width">
                            <label>Description</label>
                            <textarea id="description" rows="3" placeholder="Brief lesson summary..."></textarea>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button type="submit" class="btn" id="submitBtn">Publish Sermon</button>
                        <button type="button" class="btn btn-secondary" id="cancelBtn" onclick="resetForm()"
                            style="display: none;">Cancel</button>
                    </div>
                </form>
            </div>

            <!-- EXISTING SERMONS -->
            <div class="card">
                <h3>My Class Library</h3>
                <div id="sermonList" class="sermon-list">
                    <p style="text-align: center; color: #888;">Loading sermons...</p>
                </div>
            </div>

        </div>
    </section>

    <!-- FOOTER -->
    <footer class="site-footer">
        <div class="footer-content">
            <div class="footer-brand">
                <h3>Tudduke Okufa Ministry</h3>
                <p class="leader-text">Led by Servant Kiviri John Mark</p>
            </div>

            <div class="footer-dev">
                <p>Developed with excellence by</p>
                <a href="#" class="dev-link">Innotech Solutions Uganda</a>
            </div>
        </div>

        <div class="footer-bottom">
            <p>&copy; <span id="year"></span> Tudduke Okufa. All Rights Reserved.</p>
        </div>
    </footer>

    <script>
        /* Dynamic Year */
        document.getElementById("year").textContent = new Date().getFullYear();

        /* Sidebar Toggle */
        /* ... existing sidebar code ... */
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("overlay");
        document.getElementById("menu").onclick = () => {
            sidebar.classList.toggle("active");
            overlay.classList.toggle("active");
        };
        overlay.onclick = close;
        sidebar.querySelectorAll("a").forEach(a => a.onclick = close);
        function close() {
            sidebar.classList.remove("active");
            overlay.classList.remove("active");
        }

        /* Dashboard Logic */
        // AUTH CHECK
        // Function to get valid token from either source
        function getAuth() {
            const mToken = localStorage.getItem('ministryToken');
            const mUser = localStorage.getItem('ministryUser');
            if (mToken && mUser) return { token: mToken, user: JSON.parse(mUser) };

            const kToken = localStorage.getItem('kidsToken');
            const kUser = localStorage.getItem('kidsUser');
            if (kToken && kUser) return { token: kToken, user: JSON.parse(kUser) };

            return null;
        }

        const auth = getAuth();

        if (!auth) {
            // Default redirect to kids auth, but maybe teacher was trying to use ministry portal?
            window.location.href = 'auth.html';
        } else {
            const { user } = auth;
            if (user.role !== 'teacher') {
                alert('Access Denied: Teachers Only');
                window.location.href = 'index.html';
            }
            document.getElementById('teacherDisplay').textContent = user.fullname;
        }

        // Global token for API calls
        const token = auth ? auth.token : null;

        function logout() {
            localStorage.removeItem('kidsToken');
            localStorage.removeItem('kidsUser');
            localStorage.removeItem('ministryToken');
            localStorage.removeItem('ministryUser');
            window.location.href = 'auth.html';
        }

        // LOAD SERMONS
        async function loadSermons() {
            try {
                // Pass optional 'mine=true' param to filter by user on server (if token is valid)
                const res = await fetch('/api/kids/sermons?mine=true', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const sermons = await res.json();
                const list = document.getElementById('sermonList');

                if (sermons.length === 0) {
                    list.innerHTML = '<p style="text-align: center; color: #888;">No sermons yet.</p>';
                    return;
                }

                list.innerHTML = sermons.map(s => `
            <div class="sermon-item">
                <div class="sermon-info">
                    <h4>${s.title}</h4>
                    <p>${s.teacherName} ‚Ä¢ ${new Date(s.createdAt).toLocaleDateString()}</p>
                </div>
                <div class="actions">
                    <button onclick="editSermon('${s.sermonid}')" title="Edit" style="margin-right: 10px;">
                        <i data-feather="edit"></i>
                    </button>
                    <button onclick="deleteSermon('${s.sermonid}')" title="Delete">
                        <i data-feather="trash-2"></i>
                    </button>
                </div>
            </div>
        `).join('');
                feather.replace();
            } catch (err) {
                console.error(err);
            }
        }

        // ADD OR UPDATE SERMON
        document.getElementById('addSermonForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('editId').value;
            const isEdit = !!id;

            const data = {
                title: document.getElementById('title').value,
                videoUrl: document.getElementById('videoUrl').value,
                teacherName: document.getElementById('teacherName').value,
                description: document.getElementById('description').value
            };

            const url = isEdit ? `/api/kids/sermons/${id}` : '/api/kids/sermons';
            const method = isEdit ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    alert(isEdit ? 'Sermon Updated!' : 'Sermon Published!');
                    resetForm();
                    loadSermons();
                } else {
                    const err = await res.json();
                    alert(err.error || 'Failed to save sermon');
                }
            } catch (err) {
                console.error(err);
                alert('Error saving sermon');
            }
        });

        // DELETE SERMON
        async function deleteSermon(id) {
            if (!confirm('Are you sure you want to delete this sermon?')) return;

            try {
                const res = await fetch(`/api/kids/sermons/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (res.ok) {
                    loadSermons();
                } else {
                    alert('Failed to delete');
                }
            } catch (err) {
                console.error(err);
            }
        }

        // EDIT MODE
        async function editSermon(id) {
            try {
                const res = await fetch(`/api/kids/sermons/${id}`);
                const sermon = await res.json();

                document.getElementById('editId').value = sermon.sermonid;
                document.getElementById('title').value = sermon.title;
                document.getElementById('videoUrl').value = sermon.videoUrl || '';
                document.getElementById('teacherName').value = sermon.teacherName || '';
                document.getElementById('description').value = sermon.description || '';

                document.getElementById('formTitle').textContent = 'Edit Sermon';
                document.getElementById('submitBtn').textContent = 'Update Sermon';
                document.getElementById('cancelBtn').style.display = 'inline-block';

                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (err) {
                console.error(err);
                alert('Failed to load sermon details');
            }
        }

        function resetForm() {
            document.getElementById('addSermonForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('formTitle').textContent = 'Add New Sermon';
            document.getElementById('submitBtn').textContent = 'Publish Sermon';
            document.getElementById('cancelBtn').style.display = 'none';
        }

        // INIT
        loadSermons();

        // Socket.io Real-time Updates
        const socket = io();
        socket.on('kids_sermon_update', (data) => {
            console.log('Kids Sermon update received:', data);
            loadSermons();
        });
    </script>
    <script src="auth-helper.js"></script>
</body>

</html>